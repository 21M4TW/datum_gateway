name: Build DATUM Gateway

on:
    schedule:
        - cron: '0 0 1 * *'
    push:
    pull_request:

jobs:
  build:
    strategy:
      matrix:
        os:
          - ubuntu:latest
          - ubuntu:22.04
          - debian:latest
          - debian:stable
        config:
          - cmake_args: "-DENABLE_API=ON -DCMAKE_C_COMPILER=gcc"
            extra_deps: "gcc libmicrohttpd-dev"
          - cmake_args: "-DENABLE_API=ON -DCMAKE_C_COMPILER=clang"
            extra_deps: "clang libmicrohttpd-dev"
          - cmake_args: "-DENABLE_API=OFF"

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Build inside Docker
        run: |
          CMD="set -ex
            apt update
            apt install -y libc6-dev cmake libcurl4-openssl-dev libjansson-dev libsodium-dev pkgconf ${{ matrix.config.extra_deps }}
            git config --global --add safe.directory /workspace
            mkdir -p build
            cd build
            cmake /workspace -DCMAKE_C_FLAGS='-Wall -Werror' ${{ matrix.config.cmake_args }}
            make -j\$(nproc)
          "
          docker run \
            -v "${{ github.workspace }}:/workspace":ro \
            "${{ matrix.os }}" \
            /bin/sh -c "${CMD}"
